---
layout: post
title:  WCDB 拾遗
---

# 起因

最近开了个新项目，项目的主程童鞋引入了 `WCDB` 代替原先自撸的 `KeyValueStore` 和 `FMDB`。问为何，答曰：好用，线程安全又高效。又问具体实现细节，答曰：不懂，就是好用。作为一个负责的前 `iOS` 开发决定花点时间扒一扒 `WCDB` 的实现。

`WCDB` 的 `Wiki` 介绍了它的三大特性：易用，高效和完整。通过 `ORM` 和 `WINQ`，`WCDB` 能提供非常简洁的数据访问接口，而通过整个框架的设计及局部代码优化则使得整体较为高效。下面主要扒一扒这两个特性如何达到。至于完整性，尤其是损坏修复由于涉及过多 SQLite 文件格式，考虑有空再细细研究。//如果有需求的话

# ORM 和 WINQ

在 `iOS` 上实现 `ORM` 并不是什么新鲜事。一般的流程是给定一个类，继承基类（非必须），通过 `runtime` 获取对应属性，并使其协议或基类方法以进行约束。以 [Realm](https://realm.io/cn/docs/objc/latest/#models) 为例，所有模型需要继承自 `RLMObject` 并通过重写基类方法指定主键，忽略属性等。当这种实现一般会有如下问题：

* 部分约束方法扔使用硬编码指定，有出错概率
* 能表达约束有限

同样以 `Realm` 为例，当指定当前数据模型主键时，需要重写 `+ (NSString *)primaryKey` 方法返回属性名，不可避免使用硬编码字符串。


# 线程安全和高性能






